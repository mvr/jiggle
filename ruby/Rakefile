# Generated by mkrf
require 'rake/clean'

CLEAN.include('*.o')
CLOBBER.include('jiggle.so', 'mkrf.log')

SRC = FileList['*.c']
OBJ = SRC.ext('o')
CC = 'gcc'

ADDITIONAL_OBJECTS = '-L.. -ljiggle'

LDSHARED = "gcc -shared --enable-auto-import"

LIBPATH =  "-L/usr/lib "

INCLUDES = "-I/usr/include -I/usr/lib/ruby/1.8/i386-linux -I/usr/lib/ruby/site_ruby/1.8 -I."

LIBS = "-lpthread -ldl -lcrypt -lm"

CFLAGS = " -fPIC -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m32 -march=i386 -mtune=generic -fasynchronous-unwind-tables -Wall  -fPIC -I../src -O3 -std=gnu99 -Wall -Werror "

RUBYARCHDIR = "#{ENV["RUBYARCHDIR"]}"
LIBRUBYARG_SHARED = "-lruby"

task :default => ['jiggle.so']

rule '.o' => '.c' do |t|
  sh "#{CC} #{CFLAGS} #{INCLUDES} -c #{t.source}"
end

desc "Build this extension"
file 'jiggle.so' => OBJ do
  sh "#{LDSHARED} #{LIBPATH} -o jiggle.so #{OBJ} #{ADDITIONAL_OBJECTS} #{LIBS} #{LIBRUBYARG_SHARED}"
end

desc "Install this extension"
task :install => 'jiggle.so' do
  makedirs "#{RUBYARCHDIR}"
  install "jiggle.so", "#{RUBYARCHDIR}"
end


